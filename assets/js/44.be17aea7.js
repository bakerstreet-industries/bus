(window.webpackJsonp=window.webpackJsonp||[]).push([[44],{249:function(e,t,s){"use strict";s.r(t);var a=s(0),n=Object(a.a)({},function(){var e=this,t=e.$createElement,s=e._self._c||t;return s("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[s("h1",{attrs:{id:"reliable-service-communications-with-a-service-bus"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#reliable-service-communications-with-a-service-bus","aria-hidden":"true"}},[e._v("#")]),e._v(" Reliable service communications with a service bus")]),e._v(" "),s("p",[e._v("It's common for services to communicate with each other over HTTP. However this isn't always the best technology choice, and integrating services (or even parts of the same service) using a message bus is much simpler and reliable than you may think.")]),e._v(" "),s("p",[e._v("The following examples use "),s("a",{attrs:{href:"https://github.com/node-ts/bus",target:"_blank",rel:"noopener noreferrer"}},[e._v("@node-ts/bus"),s("OutboundLink")],1),e._v(" as the service bus.")]),e._v(" "),s("h2",{attrs:{id:"sending"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#sending","aria-hidden":"true"}},[e._v("#")]),e._v(" Sending")]),e._v(" "),s("p",[e._v("Consider the need to register a new product for our retail business. This might be modelled like so:")]),e._v(" "),s("div",{staticClass:"language-typescript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-typescript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" registerProduct "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("new")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("RegisterProduct")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("'abc-123'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" name"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("'product a'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" price"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("100")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// Sending the command using an HTTP based API endpoint:")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("await")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("request")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("'https://10.0.0.1:8080/product'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" registerProduct"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// Sending the same command using a service bus:")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("await")]),e._v(" bus"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("send")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("registerProduct"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n")])])]),s("h3",{attrs:{id:"service-discovery"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#service-discovery","aria-hidden":"true"}},[e._v("#")]),e._v(" Service discovery")]),e._v(" "),s("p",[e._v("When dealing with an HTTP endoint, how do we know that the server is at "),s("code",[e._v("10.0.0.1")]),e._v(", listening on port "),s("code",[e._v("8080")]),e._v("?")]),e._v(" "),s("ul",[s("li",[e._v("We might build in a service discovery mechanism. Perhaps build a load balancer and tell it that "),s("code",[e._v("/product")]),e._v(" requests need to be routed to a certain cluster of services.")]),e._v(" "),s("li",[e._v("Maybe replace the fixed IP with a local DNS entry to make this more reliable")]),e._v(" "),s("li",[e._v("Inject or set the configuration of this address per environment")])]),e._v(" "),s("p",[e._v("When using messaging, the message is ultimately routed to a queue where it will be processed when the service monitoring that queue is ready. Your app doesn't need to know or care where that consumer is, it just needs to send out the command and know that it will eventually be processed.")]),e._v(" "),s("h3",{attrs:{id:"service-availability"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#service-availability","aria-hidden":"true"}},[e._v("#")]),e._v(" Service Availability")]),e._v(" "),s("p",[e._v("So what happens when the service that processes the request/message is unavailable?")]),e._v(" "),s("p",[e._v("Our HTTP request will just fail even though there's nothing wrong with whatever we used to make the request. We've done our work and just want the product to be registered, but now we have to deal with a "),s("code",[e._v("5xx")]),e._v(" error in the code.")]),e._v(" "),s("p",[e._v("When working with messaging, commands are generally executed quickly - sub 10ms. If the service that processes this command does go down, then the command will sit in the queue until the service is ready and starts processing it again. No changes need to happen to the requesting process, it's fire and forget.")]),e._v(" "),s("h2",{attrs:{id:"receiving"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#receiving","aria-hidden":"true"}},[e._v("#")]),e._v(" Receiving")]),e._v(" "),s("p",[e._v("Consider processing the above command:")]),e._v(" "),s("div",{staticClass:"language-typescript extra-class"},[s("pre",{pre:!0,attrs:{class:"language-typescript"}},[s("code",[s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("import")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v(" productService "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("from")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("'./product-service'")]),e._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// Using an HTTP based API endpoint")]),e._v("\n@"),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("Controller")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("'POST'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token string"}},[e._v("'/product'")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token function-variable function"}},[e._v("controller")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token parameter"}},[e._v("request"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" response"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(",")]),e._v(" next")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=>")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("try")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("const")]),e._v(" command "),s("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v(" request"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),e._v("body "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("as")]),e._v(" RegisterProduct\n    productService"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("registerProduct")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("command"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n    response"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("status")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token number"}},[e._v("204")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("end")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("catch")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("err"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("next")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("err"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n\n"),s("span",{pre:!0,attrs:{class:"token comment"}},[e._v("// Using a message handler")]),e._v("\n@"),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("HandlesMessage")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("RegisterProduct"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("class")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token class-name"}},[e._v("RegisterProductHandler")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("handler")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("command"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" RegisterProduct"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(":")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token keyword"}},[e._v("void")]),e._v(" "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("{")]),e._v("\n    productService"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(".")]),s("span",{pre:!0,attrs:{class:"token function"}},[e._v("registerProduct")]),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("(")]),e._v("command"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v(")")]),e._v("\n  "),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n"),s("span",{pre:!0,attrs:{class:"token punctuation"}},[e._v("}")]),e._v("\n")])])]),s("h3",{attrs:{id:"verbs-and-intent"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#verbs-and-intent","aria-hidden":"true"}},[e._v("#")]),e._v(" Verbs and Intent")]),e._v(" "),s("p",[s("code",[e._v("HTTP Services")]),e._v(" should ususally conform to the technical specification on what different verbs mean. "),s("code",[e._v("POST")]),e._v(", "),s("code",[e._v("PUT")]),e._v(", "),s("code",[e._v("PATCH")]),e._v(" and "),s("code",[e._v("DELETE")]),e._v(" are all write operations that create, update or delete resources. This sometimes has the undesired effect of turning APIs into an anemic CRUD system that can discard the rich domain language used by your business.")]),e._v(" "),s("p",[s("code",[e._v("Messaging")]),e._v(" doesn't have these concepts. In fact it's useful to only have two types of intents: read and write, aka events and commands. In the above messaging example, a function receives an intent to perform an action ("),s("code",[e._v("RegisterProduct")]),e._v(") and it does that one thing. The name of the command is understandable even by non-technical users.")]),e._v(" "),s("h3",{attrs:{id:"response-statuses"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#response-statuses","aria-hidden":"true"}},[e._v("#")]),e._v(" Response Statuses")]),e._v(" "),s("p",[e._v("A key difference between HTTP APIs and fire and forget messaging is that the former is generally a synchronous technology, whereas the latter is asynchronous. As such, messaging doesn't need to worry about return statuses because there's nobody to notify.")]),e._v(" "),s("p",[s("code",[e._v("HTTP services")]),e._v(" on the other hand needs to use the set of HTTP status codes provided by the specification. Although most APIs use a small subset, they must indicate to the requestor what the outcome of processing was so that the requestor can then decide on the next step to take.")]),e._v(" "),s("h2",{attrs:{id:"error-handling"}},[s("a",{staticClass:"header-anchor",attrs:{href:"#error-handling","aria-hidden":"true"}},[e._v("#")]),e._v(" Error Handling")]),e._v(" "),s("p",[e._v("What happens when the "),s("code",[e._v("productService")]),e._v(" in the above example throws an error during processsing? For instance let's say that it tries to insert a record in a database that was being patched.")]),e._v(" "),s("p",[s("code",[e._v("HTTP Services")]),e._v(" would error out and possibly return a "),s("code",[e._v("503 Service Unavailable")]),e._v(" response. The requestor would then need to handle this response, and maybe throw an error of its own to indicate its work can't be completed, sending errors everywhere up the chain. This is made worse if the requestor already had completed half of a larger operation where the data is now in an incomplete state.")]),e._v(" "),s("p",[s("code",[e._v("Messaging")]),e._v(" by nature provides retries when errors occur. If the command is processed and an error is thrown due to the database being unavailable, the error is logged and the message is placed back on the queue. It's then picked up, and the same operation retried with a progressive delay between attempts. Eventually the database patching will finish and the next time the command is retried the process will complete sucessfully.")]),e._v(" "),s("p",[e._v("Using this approach, the requestor doesn't need to build in error handling for each command it sends out. Systems can go offline for days, but will resume normally once they're turned back on without any data loss.")])])},[],!1,null,null,null);t.default=n.exports}}]);